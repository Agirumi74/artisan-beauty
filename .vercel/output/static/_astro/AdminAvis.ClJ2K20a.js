import{j as e,I as D,B as h,D as _,a as ee,b as le,c as se}from"./input.Ax_aeIQF.js";import{r as a}from"./index.Dy7WD_uu.js";import{S as g,a as N,b as S,c as C,d as n,T as he,e as fe,f as B,g as m,h as be,i as c}from"./select.BPMtuf4o.js";function ge(){const[H,E]=a.useState([]),[y,ae]=a.useState([]),[w,te]=a.useState([]),[L,ie]=a.useState([]),[re,q]=a.useState(!0),[x,z]=a.useState(""),[O,I]=a.useState("all"),[P,F]=a.useState("all"),[V,f]=a.useState("all"),[M,b]=a.useState("all"),[R,j]=a.useState("all"),[v,J]=a.useState("all"),[U,K]=a.useState(()=>new Date().toISOString().slice(0,10)),[ne,G]=a.useState(!1),[p,Y]=a.useState(null),[i,d]=a.useState({utilisateur:"",commentaire:"",note:5,serviceId:"",formationId:"",global:0}),[$,A]=a.useState(null),[Q,T]=a.useState(!1),[k,u]=a.useState("");a.useEffect(()=>{Promise.all([fetch("/api/avis-db").then(l=>l.json()),fetch("/api/service-db").then(l=>l.json()),fetch("/api/formation-db").then(l=>l.json()).then(l=>l.data),fetch("/api/utilisateur-db").then(l=>l.json())]).then(([l,s,t,o])=>{E(l),ae(s),te(t),ie(o),q(!1)}).catch(()=>q(!1))},[]);function oe(l){if(v==="all"||!l)return!0;const s=new Date(l),t=new Date(U);return isNaN(s)||isNaN(t)?!0:v==="day"?s.toISOString().slice(0,10)===t.toISOString().slice(0,10):v==="month"?s.getFullYear()===t.getFullYear()&&s.getMonth()===t.getMonth():v==="year"?s.getFullYear()===t.getFullYear():!0}const W=H.filter(l=>{if(O!=="all"&&String(l.serviceId)!==O||P!=="all"&&String(l.formationId)!==P||V!=="all"&&String(l.global)!==V||M!=="all"&&String(l.servicesGlobal)!==M||R!=="all"&&String(l.formationsGlobal)!==R||!oe(l.createdAt))return!1;if(x){const s=L.find(r=>r.id==l.utilisateur),t=y.find(r=>r.id==l.serviceId),o=w.find(r=>r.id==l.formationId);return l.utilisateur?.toLowerCase().includes(x.toLowerCase())||l.commentaire?.toLowerCase().includes(x.toLowerCase())||s&&(s.nom?.toLowerCase().includes(x.toLowerCase())||s.email?.toLowerCase().includes(x.toLowerCase()))||t&&t.nom?.toLowerCase().includes(x.toLowerCase())||o&&o.titre?.toLowerCase().includes(x.toLowerCase())}return!0}),ce=()=>{Y(null),d({utilisateur:"",commentaire:"",note:5,serviceId:"",global:0}),G(!0)},de=l=>{Y(l.id),d({utilisateur:l.utilisateur,commentaire:l.commentaire,note:l.note,serviceId:l.serviceId||"",global:l.global||0}),G(!0)},X=()=>{G(!1),Y(null),d({utilisateur:"",commentaire:"",note:5,serviceId:"",global:0}),u("")},Z=l=>{const{name:s,value:t,type:o}=l.target;d(r=>({...r,[s]:o==="number"?Number(t):t}))},me=async l=>{l.preventDefault(),T(!0),u("");try{const s=p?"PATCH":"POST",t=p?`/api/avis-db?id=${p}`:"/api/avis-db",o={...i,note:Number(i.note),global:Number(i.global),serviceId:i.serviceId?Number(i.serviceId):null};(await fetch(t,{method:s,headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).ok?(u(p?"Avis modifié !":"Avis ajouté !"),E(await fetch("/api/avis-db").then(xe=>xe.json())),X()):u("Erreur lors de l'enregistrement.")}catch{u("Erreur réseau.")}T(!1)},ue=async()=>{if($){T(!0),u("");try{(await fetch(`/api/avis-db?id=${$}`,{method:"DELETE"})).ok?(u("Avis supprimé."),E(await fetch("/api/avis-db").then(s=>s.json())),A(null)):u("Erreur lors de la suppression.")}catch{u("Erreur réseau.")}T(!1)}};return re?e.jsx("div",{className:"text-center py-12",children:"Chargement..."}):H?e.jsxs("div",{className:"w-full max-w-6xl mx-auto px-2 md:px-0",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Avis"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsx(D,{type:"text",placeholder:"Recherche... (auteur, contenu, service, email)",value:x,onChange:l=>z(l.target.value),className:"max-w-xs"}),e.jsx(h,{onClick:ce,variant:"default",className:"w-full sm:w-auto",children:"Ajouter"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4 items-center bg-gray-50 p-3 rounded-lg shadow-sm",children:[e.jsx(h,{type:"button",variant:"secondary",onClick:()=>{I("all"),F("all"),f("all"),b("all"),j("all"),J("all"),K(new Date().toISOString().slice(0,10)),z("")},children:"Réinitialiser"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-semibold",children:"Service"}),e.jsxs(g,{value:O,onValueChange:l=>{I(l),l!=="all"&&(f("0"),b("0"),j("0"))},children:[e.jsx(N,{className:"w-40",children:e.jsx(S,{placeholder:"Tous les services"})}),e.jsxs(C,{children:[e.jsx(n,{value:"all",children:"Tous les services"}),y.map(l=>e.jsx(n,{value:String(l.id),children:l.nom},l.id))]})]})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-semibold",children:"Formation"}),e.jsxs(g,{value:P,onValueChange:l=>{F(l),l!=="all"&&(f("0"),b("0"),j("0"))},children:[e.jsx(N,{className:"w-40",children:e.jsx(S,{placeholder:"Toutes les formations"})}),e.jsxs(C,{children:[e.jsx(n,{value:"all",children:"Toutes les formations"}),w.map(l=>e.jsx(n,{value:String(l.id),children:l.titre},l.id))]})]})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-semibold",children:"Type d’avis"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("label",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"radio",name:"globalType",value:"global",checked:V==="1",onChange:()=>{f("1"),b("all"),j("all"),I("all"),F("all")}})," Global"]}),e.jsxs("label",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"radio",name:"globalType",value:"servicesGlobal",checked:M==="1",onChange:()=>{f("0"),b("1"),j("all"),F("all")}})," Services global"]}),e.jsxs("label",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"radio",name:"globalType",value:"formationsGlobal",checked:R==="1",onChange:()=>{f("0"),b("all"),j("1"),I("all")}})," Formations global"]})]})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-semibold",children:"Période"}),e.jsxs(g,{value:v,onValueChange:J,children:[e.jsx(N,{className:"w-32",children:e.jsx(S,{placeholder:"Période"})}),e.jsxs(C,{children:[e.jsx(n,{value:"all",children:"Toutes dates"}),e.jsx(n,{value:"day",children:"Jour"}),e.jsx(n,{value:"month",children:"Mois"}),e.jsx(n,{value:"year",children:"Année"})]})]})]}),v!=="all"&&e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-semibold",children:"Date"}),e.jsx(D,{type:"date",value:U,onChange:l=>K(l.target.value),className:"w-36",min:"2000-01-01",max:"2100-12-31"})]})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg shadow bg-white p-2 md:p-4",children:e.jsxs(he,{children:[e.jsx(fe,{children:e.jsxs(B,{children:[e.jsx(m,{children:"Auteur"}),e.jsx(m,{children:"Note"}),e.jsx(m,{children:"Contenu"}),e.jsx(m,{children:"Service"}),e.jsx(m,{children:"Formation"}),e.jsx(m,{children:"Global"}),e.jsx(m,{children:"Services Global"}),e.jsx(m,{children:"Formations Global"}),e.jsx(m,{children:"Date"}),e.jsx(m,{children:"Actions"})]})}),e.jsx(be,{children:W.length===0?e.jsx(B,{children:e.jsx(c,{colSpan:7,className:"text-center",children:"Aucun avis"})}):[...W].sort((l,s)=>(s.createdAt||"").localeCompare(l.createdAt||"")).map(l=>{const s=L.find(r=>r.id==l.utilisateur),t=y.find(r=>r.id==l.serviceId),o=w.find(r=>r.id==l.formationId);return e.jsxs(B,{children:[e.jsx(c,{children:s?`${s.nom} (${s.email})`:l.utilisateur}),e.jsx(c,{children:l.note??"-"}),e.jsx(c,{children:l.commentaire}),e.jsx(c,{children:t?t.nom:e.jsx("span",{className:"text-gray-400",children:"-"})}),e.jsx(c,{children:o?o.titre:e.jsx("span",{className:"text-gray-400",children:"-"})}),e.jsx(c,{children:l.global?"Oui":"Non"}),e.jsx(c,{children:l.servicesGlobal?"Oui":"Non"}),e.jsx(c,{children:l.formationsGlobal?"Oui":"Non"}),e.jsx(c,{children:l.createdAt?l.createdAt.slice(0,10):"-"}),e.jsxs(c,{className:"flex gap-2",children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>de(l),children:"Éditer"}),e.jsx(h,{size:"sm",variant:"destructive",onClick:()=>A(l.id),children:"Supprimer"})]})]},l.id)})})]})}),e.jsx(_,{open:ne,onOpenChange:G,children:e.jsxs(ee,{className:"max-w-lg w-full",children:[e.jsx(le,{children:p?"Modifier l'avis":"Ajouter un avis"}),e.jsxs("form",{onSubmit:me,className:"flex flex-col gap-4 mt-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Auteur"}),e.jsxs(g,{value:i.utilisateur||"",onValueChange:l=>d(s=>({...s,utilisateur:l})),children:[e.jsx(N,{children:e.jsx(S,{placeholder:"Choisir un utilisateur"})}),e.jsx(C,{children:L.map(l=>e.jsxs(n,{value:String(l.id),children:[l.nom," (",l.email,")"]},l.id))})]})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Service"}),e.jsxs(g,{value:i.serviceId||"",onValueChange:l=>{d(s=>({...s,serviceId:l,global:0,servicesGlobal:0,formationsGlobal:0}))},disabled:i.global===1||i.servicesGlobal===1,children:[e.jsx(N,{children:e.jsx(S,{placeholder:"Choisir un service"})}),e.jsxs(C,{children:[e.jsx(n,{value:"",children:"Aucun"}),y.map(l=>e.jsx(n,{value:String(l.id),children:l.nom},l.id))]})]})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Formation"}),e.jsxs(g,{value:i.formationId||"",onValueChange:l=>{d(s=>({...s,formationId:l,global:0,servicesGlobal:0,formationsGlobal:0}))},disabled:i.global===1||i.formationsGlobal===1,children:[e.jsx(N,{children:e.jsx(S,{placeholder:"Choisir une formation"})}),e.jsxs(C,{children:[e.jsx(n,{value:"",children:"Aucune"}),w.map(l=>e.jsx(n,{value:String(l.id),children:l.titre},l.id))]})]})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Note"}),e.jsx(D,{name:"note",type:"number",min:1,max:5,value:i.note,onChange:Z,required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Contenu"}),e.jsx(D,{name:"commentaire",type:"text",value:i.commentaire,onChange:Z,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Type d’avis"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("label",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"radio",name:"globalTypeForm",value:"global",checked:i.global===1,onChange:()=>d(l=>({...l,global:1,servicesGlobal:0,formationsGlobal:0,serviceId:"",formationId:""}))})," Global"]}),e.jsxs("label",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"radio",name:"globalTypeForm",value:"servicesGlobal",checked:i.servicesGlobal===1,onChange:()=>d(l=>({...l,global:0,servicesGlobal:1,formationsGlobal:0,formationId:""}))})," Services global"]}),e.jsxs("label",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"radio",name:"globalTypeForm",value:"formationsGlobal",checked:i.formationsGlobal===1,onChange:()=>d(l=>({...l,global:0,servicesGlobal:0,formationsGlobal:1,serviceId:""}))})," Formations global"]})]})]}),k&&e.jsx("div",{className:"text-sm text-center text-pink-700 font-semibold",children:k}),e.jsxs(se,{children:[e.jsx(h,{type:"button",variant:"secondary",onClick:X,children:"Annuler"}),e.jsx(h,{type:"submit",variant:"default",disabled:Q,children:p?"Enregistrer":"Ajouter"})]})]})]})}),e.jsx(_,{open:!!$,onOpenChange:l=>{l||A(null)},children:e.jsxs(ee,{className:"max-w-md w-full",children:[e.jsx(le,{children:"Supprimer l'avis ?"}),e.jsx("div",{className:"py-4",children:"Cette action est irréversible. Confirmer la suppression ?"}),k&&e.jsx("div",{className:"text-sm text-center text-pink-700 font-semibold",children:k}),e.jsxs(se,{children:[e.jsx(h,{type:"button",variant:"secondary",onClick:()=>A(null),children:"Annuler"}),e.jsx(h,{type:"button",variant:"destructive",onClick:ue,disabled:Q,children:"Supprimer"})]})]})})]}):e.jsx("div",{className:"text-center py-12 text-red-600",children:"Erreur de chargement des avis."})}export{ge as default};

import{j as e,S as Ie,d as De,e as ke,I as F,B as f,D as te,a as ne,b as ae,c as re}from"./input.Ax_aeIQF.js";import{r}from"./index.Dy7WD_uu.js";import{S as w,a as S,b as y,c as C,d as l,T as Ae,e as Fe,f as W,g as j,h as Te,i as m}from"./select.BPMtuf4o.js";const Ee=ke("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground"}},defaultVariants:{variant:"default"}});function Re({className:T,variant:I,asChild:u=!1,...H}){const c=u?Ie:"span";return e.jsx(c,{"data-slot":"badge",className:De(Ee({variant:I}),T),...H})}function Ve(){const[T,I]=r.useState([]),[u,H]=r.useState([]),[c,le]=r.useState([]),[ie,G]=r.useState(!0),[b,ce]=r.useState(""),[de,E]=r.useState(!1),[N,L]=r.useState(null),[i,v]=r.useState({userId:"",serviceId:"",date:"",time:"",status:"pending",notes:""}),[M,R]=r.useState(null),[K,O]=r.useState(!1),[$,d]=r.useState("");r.useEffect(()=>{console.log("[AdminReservations] Fetching reservations, users, services..."),Promise.all([fetch("/api/reservation-db").then(s=>s.json()),fetch("/api/utilisateur-db").then(s=>s.json()),fetch("/api/service-db").then(s=>s.json())]).then(([s,t,n])=>{console.log("[AdminReservations] Reservations:",s),console.log("[AdminReservations] Users:",t),console.log("[AdminReservations] Services:",n),setTimeout(()=>{I(s),H(t),le(n),G(!1)},1e3)}).catch(s=>{console.error("[AdminReservations] Error fetching data:",s),G(!1)})},[]);const[Y,oe]=r.useState("all"),[B,ue]=r.useState("all"),[g,xe]=r.useState("all"),[Q,he]=r.useState(()=>new Date().toISOString().slice(0,10));function me(s){if(g==="all")return!0;const t=new Date(s),n=new Date(Q);if(isNaN(t)||isNaN(n))return!0;if(g==="day")return t.toISOString().slice(0,10)===n.toISOString().slice(0,10);if(g==="week"){const a=se=>{const p=new Date(se);return p.setDate(p.getDate()-(p.getDay()+6)%7),p.setHours(0,0,0,0),p};return a(t).getTime()===a(n).getTime()&&t.getFullYear()===n.getFullYear()}return g==="month"?t.getFullYear()===n.getFullYear()&&t.getMonth()===n.getMonth():g==="year"?t.getFullYear()===n.getFullYear():!0}const o=T.filter(s=>{if(Y!=="all"&&s.serviceId?.toString()!==Y||B!=="all"&&s.status!==B||!me(s.date))return!1;if(b){const t=u.find(a=>a.id===s.userId),n=c.find(a=>a.id===s.serviceId);return s.id.toString().includes(b)||t&&(t.nom?.toLowerCase().includes(b.toLowerCase())||t.email?.toLowerCase().includes(b.toLowerCase()))||n&&n.nom?.toLowerCase().includes(b.toLowerCase())}return!0}),ve=()=>{L(null),v({userId:"",serviceId:"",date:"",time:"",status:"pending",notes:""}),E(!0)},ge=s=>{L(s.id),v({userId:s.userId,serviceId:s.serviceId,date:s.date,time:s.time,status:s.status,notes:s.notes||""}),E(!0)},X=()=>{E(!1),L(null),v({userId:"",serviceId:"",date:"",time:"",status:"pending",notes:""}),d("")},z=s=>{const{name:t,value:n}=s.target;v(a=>({...a,[t]:n}))},pe=async s=>{s.preventDefault(),O(!0),d("");try{const t=N?"PATCH":"POST",n=N?`/api/reservation-db?id=${N}`:"/api/reservation-db",a={...i,userId:i.userId?Number(i.userId):"",serviceId:i.serviceId?Number(i.serviceId):""};if((await fetch(n,{method:t,headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok){d(N?"Réservation modifiée !":"Réservation ajoutée !");const p=await fetch("/api/reservation-db").then(Ce=>Ce.json());I(p),X()}else d("Erreur lors de l'enregistrement.")}catch{d("Erreur réseau.")}O(!1)},fe=async()=>{if(M){O(!0),d("");try{const s=Number(M);(await fetch(`/api/reservation-db?id=${s}`,{method:"DELETE"})).ok?(d("Réservation supprimée."),I(await fetch("/api/reservation-db").then(n=>n.json())),R(null)):d("Erreur lors de la suppression.")}catch{d("Erreur réseau.")}O(!1)}};if(ie)return e.jsx("div",{className:"text-center py-12",children:"Chargement..."});if(!T||!u||!c)return e.jsx("div",{className:"text-center py-12 text-red-600",children:"Erreur de chargement des données."});const x=new Date,h=s=>new Date(s.date+"T"+(s.time||"00:00")),P=o.filter(s=>h(s)>=x),je=o.filter(s=>h(s)<x),D=P.sort((s,t)=>h(s)-h(t))[0],k=je.sort((s,t)=>h(t)-h(s))[0],be=x.toISOString().slice(0,10),Ne=o.filter(s=>s.date===be),A=new Date(x);A.setDate(x.getDate()-(x.getDay()+6)%7),A.setHours(0,0,0,0);const q=new Date(A);q.setDate(A.getDate()+6),q.setHours(23,59,59,999);const we=o.filter(s=>{const t=h(s);return t>=A&&t<=q}),Se=o.filter(s=>{const t=h(s);return t.getFullYear()===x.getFullYear()&&t.getMonth()===x.getMonth()}),J={};o.forEach(s=>{s.serviceId&&(J[s.serviceId]=(J[s.serviceId]||0)+1)});const Z=Object.entries(J).sort((s,t)=>t[1]-s[1]).slice(0,3).map(([s,t])=>{const n=c.find(a=>a.id.toString()===s);return n?`${n.nom} (${t})`:`Service #${s} (${t})`}),U={};o.forEach(s=>{U[s.status]=(U[s.status]||0)+1});const ye=Object.entries(U).sort((s,t)=>t[1]-s[1])[0]?.[0]||"N/A",V=[],_=P.filter(s=>s.status==="cancelled");_.length&&V.push(`${_.length} réservation(s) annulée(s) à venir`);const ee=P.filter(s=>s.status==="pending");return ee.length&&V.push(`${ee.length} réservation(s) en attente à traiter`),e.jsxs("div",{className:"w-full max-w-7xl mx-auto px-2 md:px-0",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Réservations"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsx(F,{type:"text",placeholder:"Recherche... (nom, email, service)",value:b,onChange:s=>ce(s.target.value),className:"max-w-xs"}),e.jsx(f,{onClick:ve,variant:"default",className:"w-full sm:w-auto",children:"Ajouter"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3 mb-4",children:[e.jsxs("div",{className:"rounded-lg bg-blue-50 p-4 flex flex-col gap-1 shadow-sm min-h-[90px]",children:[e.jsx("span",{className:"text-xs text-blue-700",children:"Prochaine réservation"}),D?e.jsxs("span",{className:"font-bold text-base text-blue-900",children:[D.date," ",D.time," — ",(()=>{const s=u.find(t=>t.id===D.userId);return s?s.nom:"Client"})()," (",(()=>{const s=c.find(t=>t.id===D.serviceId);return s?s.nom:"Service"})(),")"]}):e.jsx("span",{className:"text-gray-400",children:"Aucune à venir"})]}),e.jsxs("div",{className:"rounded-lg bg-gray-50 p-4 flex flex-col gap-1 shadow-sm min-h-[90px]",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Dernière passée"}),k?e.jsxs("span",{className:"font-bold text-base text-gray-800",children:[k.date," ",k.time," — ",(()=>{const s=u.find(t=>t.id===k.userId);return s?s.nom:"Client"})()," (",(()=>{const s=c.find(t=>t.id===k.serviceId);return s?s.nom:"Service"})(),")"]}):e.jsx("span",{className:"text-gray-400",children:"Aucune passée"})]}),e.jsxs("div",{className:"rounded-lg bg-green-50 p-4 flex flex-col gap-1 shadow-sm min-h-[90px]",children:[e.jsx("span",{className:"text-xs text-green-700",children:"À venir"}),e.jsx("span",{className:"font-bold text-lg text-green-900",children:P.length}),e.jsxs("span",{className:"text-xs text-green-700",children:["Aujourd’hui : ",Ne.length," / Semaine : ",we.length," / Mois : ",Se.length]})]}),e.jsxs("div",{className:"rounded-lg bg-pink-50 p-4 flex flex-col gap-1 shadow-sm min-h-[90px]",children:[e.jsx("span",{className:"text-xs text-pink-700",children:"Top services"}),Z.length?Z.map((s,t)=>e.jsxs("span",{className:"text-pink-900 text-sm",children:[t+1,". ",s]},t)):e.jsx("span",{className:"text-gray-400",children:"Aucun"})]}),e.jsxs("div",{className:"rounded-lg bg-yellow-50 p-4 flex flex-col gap-1 shadow-sm min-h-[90px] md:col-span-2 xl:col-span-1",children:[e.jsx("span",{className:"text-xs text-yellow-700",children:"Statut dominant"}),e.jsx("span",{className:"font-bold text-base text-yellow-900",children:ye})]}),e.jsxs("div",{className:"rounded-lg bg-red-50 p-4 flex flex-col gap-1 shadow-sm min-h-[90px] md:col-span-2 xl:col-span-1",children:[e.jsx("span",{className:"text-xs text-red-700",children:"Alertes"}),V.length?V.map((s,t)=>e.jsx("span",{className:"text-red-900 text-sm",children:s},t)):e.jsx("span",{className:"text-gray-400",children:"Aucune alerte"})]})]}),e.jsxs("div",{className:"overflow-x-auto rounded-lg shadow bg-white p-2 md:p-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 mb-2 items-center",children:[e.jsxs(w,{value:g,onValueChange:s=>xe(s),children:[e.jsx(S,{className:"w-36",children:e.jsx(y,{placeholder:"Période"})}),e.jsxs(C,{children:[e.jsx(l,{value:"all",children:"Toutes dates"}),e.jsx(l,{value:"day",children:"Jour"}),e.jsx(l,{value:"week",children:"Semaine"}),e.jsx(l,{value:"month",children:"Mois"}),e.jsx(l,{value:"year",children:"Année"})]})]}),g!=="all"&&e.jsx(F,{type:"date",value:Q,onChange:s=>he(s.target.value),className:"w-40",min:"2000-01-01",max:"2100-12-31"}),e.jsxs(w,{value:Y,onValueChange:s=>oe(s),children:[e.jsx(S,{className:"w-40",children:e.jsx(y,{placeholder:"Filtrer par service"})}),e.jsxs(C,{children:[e.jsx(l,{value:"all",children:"Tous les services"}),c.map(s=>e.jsx(l,{value:s.id.toString(),children:s.nom},s.id))]})]}),e.jsxs(w,{value:B,onValueChange:s=>ue(s),children:[e.jsx(S,{className:"w-40",children:e.jsx(y,{placeholder:"Filtrer par statut"})}),e.jsxs(C,{children:[e.jsx(l,{value:"all",children:"Tous statuts"}),e.jsx(l,{value:"pending",children:"En attente"}),e.jsx(l,{value:"confirmed",children:"Confirmée"}),e.jsx(l,{value:"cancelled",children:"Annulée"})]})]})]}),e.jsxs(Ae,{children:[e.jsx(Fe,{children:e.jsxs(W,{children:[e.jsx(j,{children:"Client"}),e.jsx(j,{children:"Service"}),e.jsx(j,{children:"Date"}),e.jsx(j,{children:"Heure"}),e.jsx(j,{children:"Statut"}),e.jsx(j,{children:"Notes"}),e.jsx(j,{children:"Actions"})]})}),e.jsx(Te,{children:o.length===0?e.jsx(W,{children:e.jsx(m,{colSpan:7,className:"text-center",children:"Aucune réservation"})}):[...o].sort((s,t)=>t.date.localeCompare(s.date)).map(s=>{const t=u.find(a=>a.id===s.userId),n=c.find(a=>a.id===s.serviceId);return e.jsxs(W,{children:[e.jsx(m,{children:t?`${t.nom} (${t.email})`:e.jsx("span",{className:"text-gray-400",children:"Inconnu"})}),e.jsx(m,{children:n?n.nom:e.jsx("span",{className:"text-gray-400",children:"Inconnu"})}),e.jsx(m,{children:s.date}),e.jsx(m,{children:s.time}),e.jsx(m,{children:e.jsx(Re,{variant:s.status==="confirmed"?"default":s.status==="cancelled"?"destructive":"secondary",children:s.status})}),e.jsx(m,{className:"max-w-xs truncate",title:s.notes,children:s.notes||e.jsx("span",{className:"text-gray-400",children:"-"})}),e.jsxs(m,{className:"flex gap-2",children:[e.jsx(f,{size:"sm",variant:"outline",onClick:()=>ge(s),children:"Éditer"}),e.jsx(f,{size:"sm",variant:"destructive",onClick:()=>R(s.id),children:"Supprimer"})]})]},s.id)})})]})]}),e.jsx(te,{open:de,onOpenChange:E,children:e.jsxs(ne,{className:"max-w-lg w-full",children:[e.jsx(ae,{children:N?"Modifier la réservation":"Ajouter une réservation"}),e.jsxs("form",{onSubmit:pe,className:"flex flex-col gap-4 mt-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Client"}),e.jsxs(w,{value:i.userId||"",onValueChange:s=>v(t=>({...t,userId:s})),children:[e.jsx(S,{children:e.jsx(y,{placeholder:"Choisir un utilisateur"})}),e.jsx(C,{children:u.map(s=>e.jsxs(l,{value:s.id.toString(),children:[s.nom," (",s.email,")"]},s.id))})]})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Service"}),e.jsxs(w,{value:i.serviceId||"",onValueChange:s=>v(t=>({...t,serviceId:s})),children:[e.jsx(S,{children:e.jsx(y,{placeholder:"Choisir un service"})}),e.jsx(C,{children:c.map(s=>e.jsx(l,{value:s.id.toString(),children:s.nom},s.id))})]})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Date"}),e.jsx(F,{name:"date",type:"date",value:i.date,onChange:z,required:!0})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Heure"}),e.jsx(F,{name:"time",type:"time",value:i.time,onChange:z,required:!0})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Statut"}),e.jsxs(w,{value:i.status||"pending",onValueChange:s=>v(t=>({...t,status:s})),children:[e.jsx(S,{children:e.jsx(y,{})}),e.jsxs(C,{children:[e.jsx(l,{value:"pending",children:"En attente"}),e.jsx(l,{value:"confirmed",children:"Confirmée"}),e.jsx(l,{value:"cancelled",children:"Annulée"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Notes (optionnel)"}),e.jsx(F,{name:"notes",type:"text",value:i.notes,onChange:z,placeholder:"Notes, précisions, etc."})]}),$&&e.jsx("div",{className:"text-sm text-center text-pink-700 font-semibold",children:$}),e.jsxs(re,{children:[e.jsx(f,{type:"button",variant:"secondary",onClick:X,children:"Annuler"}),e.jsx(f,{type:"submit",variant:"default",disabled:K,children:N?"Enregistrer":"Ajouter"})]})]})]})}),e.jsx(te,{open:!!M,onOpenChange:s=>{s||R(null)},children:e.jsxs(ne,{className:"max-w-md w-full",children:[e.jsx(ae,{children:"Supprimer la réservation ?"}),e.jsx("div",{className:"py-4",children:"Cette action est irréversible. Confirmer la suppression ?"}),$&&e.jsx("div",{className:"text-sm text-center text-pink-700 font-semibold",children:$}),e.jsxs(re,{children:[e.jsx(f,{type:"button",variant:"secondary",onClick:()=>R(null),children:"Annuler"}),e.jsx(f,{type:"button",variant:"destructive",onClick:fe,disabled:K,children:"Supprimer"})]})]})})]})}export{Ve as default};

import{j as e,B as c,I as E,D as B,a as H,b as V,f as ie,c as _}from"./input.Ax_aeIQF.js";import{R as t}from"./index.Dy7WD_uu.js";import{S as G,a as J,b as Z,c as K,d as D,T as re,e as ne,f as L,g as f,h as ce,i as h}from"./select.BPMtuf4o.js";const oe=[5,10,20,50,100];function xe(){const[Q,P]=t.useState([]),[de,R]=t.useState(!0),[z,W]=t.useState(""),[I,X]=t.useState("all"),[Y,b]=t.useState(!1),[a,O]=t.useState(null),[l,g]=t.useState({nom:"",email:"",role:"client",password:""}),[v,i]=t.useState(""),[y,x]=t.useState(!1),[M,C]=t.useState(null),[S,k]=t.useState(""),[p,j]=t.useState(1),[N,ee]=t.useState(10),[r,w]=t.useState({key:"createdAt",dir:"desc"});t.useEffect(()=>{R(!0),fetch("/api/utilisateur-db").then(s=>s.json()).then(s=>{P(s),R(!1)}).catch(()=>R(!1))},[]),t.useEffect(()=>{if(S){const s=setTimeout(()=>k(""),2500);return()=>clearTimeout(s)}},[S]);const A=s=>{const{name:d,value:u}=s.target;g(m=>({...m,[d]:u}))},se=()=>{O(null),g({nom:"",email:"",role:"client",password:""}),b(!0),i("")},te=s=>{O(s.id),g({nom:s.nom,email:s.email,role:s.role,password:""}),b(!0),i("")},$=()=>{b(!1),O(null),g({nom:"",email:"",role:"client",password:""}),i("")},ae=async s=>{if(s.preventDefault(),x(!0),i(""),!l.nom.trim()||!l.email.trim()||!l.role.trim()||!a&&!l.password.trim()){i("Tous les champs sont obligatoires (mot de passe requis à la création)."),x(!1);return}try{const d=a?"PATCH":"POST",u=a?`/api/utilisateur-db?id=${a}`:"/api/utilisateur-db",m={...l};a&&!l.password&&delete m.password,(await fetch(u,{method:d,headers:{"Content-Type":"application/json"},body:JSON.stringify(m)})).ok?(k(a?"Utilisateur modifié !":"Utilisateur ajouté !"),P(await fetch("/api/utilisateur-db").then(n=>n.json())),$()):i("Erreur lors de l'enregistrement.")}catch{i("Erreur réseau.")}x(!1)},le=async()=>{if(M){x(!0),i("");try{(await fetch(`/api/utilisateur-db?id=${M}`,{method:"DELETE"})).ok?(k("Utilisateur supprimé."),P(await fetch("/api/utilisateur-db").then(d=>d.json())),C(null)):i("Erreur lors de la suppression.")}catch{i("Erreur réseau.")}x(!1)}};let T=Q.filter(s=>!(z&&!`${s.nom} ${s.email}`.toLowerCase().includes(z.toLowerCase())||I!=="all"&&s.role!==I));T=T.sort((s,d)=>{const{key:u,dir:m}=r;let o=s[u]||"",n=d[u]||"";return u==="createdAt"?(o=o||"",n=n||"",m==="asc"?o.localeCompare(n):n.localeCompare(o)):typeof o=="string"&&typeof n=="string"?m==="asc"?o.localeCompare(n):n.localeCompare(o):0});const F=T.length,U=Math.max(1,Math.ceil(F/N)),q=T.slice((p-1)*N,p*N);return e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2 justify-between items-center mb-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Utilisateurs"}),e.jsx(c,{onClick:se,children:"Ajouter"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4 items-end",children:[e.jsx(E,{placeholder:"Recherche nom/email...",value:z,onChange:s=>{W(s.target.value),j(1)},className:"w-48"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Rôle"}),e.jsxs(G,{value:I,onValueChange:s=>{X(s),j(1)},children:[e.jsx(J,{className:"w-32",children:e.jsx(Z,{placeholder:"Tous les rôles"})}),e.jsxs(K,{children:[e.jsx(D,{value:"all",children:"Tous"}),e.jsx(D,{value:"admin",children:"Admin"}),e.jsx(D,{value:"client",children:"Client"})]})]})]})]}),e.jsxs(re,{children:[e.jsx(ne,{children:e.jsxs(L,{children:[e.jsxs(f,{className:"cursor-pointer",onClick:()=>w(s=>({key:"nom",dir:s.key==="nom"&&s.dir==="asc"?"desc":"asc"})),children:["Nom ",r.key==="nom"?r.dir==="asc"?"▲":"▼":null]}),e.jsxs(f,{className:"cursor-pointer",onClick:()=>w(s=>({key:"email",dir:s.key==="email"&&s.dir==="asc"?"desc":"asc"})),children:["Email ",r.key==="email"?r.dir==="asc"?"▲":"▼":null]}),e.jsxs(f,{className:"cursor-pointer",onClick:()=>w(s=>({key:"role",dir:s.key==="role"&&s.dir==="asc"?"desc":"asc"})),children:["Rôle ",r.key==="role"?r.dir==="asc"?"▲":"▼":null]}),e.jsxs(f,{className:"cursor-pointer",onClick:()=>w(s=>({key:"createdAt",dir:s.key==="createdAt"&&s.dir==="asc"?"desc":"asc"})),children:["Créé le ",r.key==="createdAt"?r.dir==="asc"?"▲":"▼":null]}),e.jsx(f,{children:"Actions"})]})}),e.jsx(ce,{children:q.length===0?e.jsx(L,{children:e.jsx(h,{colSpan:5,children:"Aucun utilisateur."})}):q.map(s=>e.jsxs(L,{children:[e.jsx(h,{children:s.nom}),e.jsx(h,{children:s.email}),e.jsx(h,{children:s.role}),e.jsx(h,{children:s.createdAt?s.createdAt.slice(0,10):"-"}),e.jsxs(h,{children:[e.jsx(c,{variant:"outline",size:"sm",onClick:()=>te(s),children:"Éditer"}),e.jsx(c,{variant:"destructive",size:"sm",onClick:()=>C(s.id),children:"Supprimer"})]})]},s.id))})]}),e.jsxs("div",{className:"flex flex-wrap justify-between items-center mt-4 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:["Page ",p," / ",U]}),e.jsxs(G,{value:String(N),onValueChange:s=>{ee(Number(s)),j(1)},children:[e.jsx(J,{className:"w-24 h-8 text-xs",children:e.jsx(Z,{})}),e.jsx(K,{children:oe.map(s=>e.jsxs(D,{value:String(s),children:[s," / page"]},s))})]})]}),e.jsxs("div",{className:"flex gap-2",children:[p>1&&e.jsx(c,{type:"button",size:"sm",variant:"secondary",onClick:()=>j(s=>Math.max(1,s-1)),"aria-label":"Page précédente",children:"Précédent"}),p<U&&e.jsx(c,{type:"button",size:"sm",variant:"secondary",onClick:()=>j(s=>Math.min(U,s+1)),"aria-label":"Page suivante",children:"Suivant"})]}),e.jsxs("span",{className:"text-xs text-gray-500",children:[F," utilisateur",F>1?"s":""]})]}),e.jsx(B,{open:Y,onOpenChange:b,children:e.jsxs(H,{children:[e.jsx(V,{children:a?"Modifier l'utilisateur":"Ajouter un utilisateur"}),e.jsx(ie,{"aria-describedby":"Formulaire utilisateur",children:a?"Modifiez les informations de l'utilisateur.":"Remplissez le formulaire pour ajouter un nouvel utilisateur."}),e.jsxs("form",{onSubmit:ae,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Nom"}),e.jsx(E,{name:"nom",value:l.nom,onChange:A,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Email"}),e.jsx(E,{name:"email",value:l.email,onChange:A,required:!0,type:"email",autoComplete:"email"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Rôle"}),e.jsxs("select",{name:"role",value:l.role,onChange:A,className:"w-full border rounded px-3 py-2",children:[e.jsx("option",{value:"client",children:"Client"}),e.jsx("option",{value:"admin",children:"Admin"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-xs font-semibold mb-1",children:["Mot de passe ",a?e.jsx("span",{className:"text-gray-500",children:"(laisser vide pour ne pas changer)"}):null]}),e.jsx(E,{name:"password",value:l.password,onChange:A,type:"password",autoComplete:"new-password",minLength:6,placeholder:a?"Nouveau mot de passe (optionnel)":"Mot de passe (min 6 caractères)"})]})]}),e.jsxs(_,{children:[e.jsx(c,{type:"button",variant:"secondary",onClick:$,disabled:y,children:"Annuler"}),e.jsx(c,{type:"submit",variant:"default",disabled:y,children:a?"Enregistrer":"Ajouter"})]}),v&&e.jsx("div",{className:"text-sm text-center text-red-600 mt-2",children:v})]})]})}),e.jsx(B,{open:!!M,onOpenChange:s=>{s||C(null)},children:e.jsxs(H,{children:[e.jsx(V,{children:"Supprimer l'utilisateur ?"}),e.jsx("div",{children:"Cette action est irréversible."}),e.jsxs(_,{children:[e.jsx(c,{type:"button",variant:"secondary",onClick:()=>C(null),disabled:y,children:"Annuler"}),e.jsx(c,{type:"button",variant:"destructive",onClick:le,disabled:y,children:"Supprimer"})]}),v&&e.jsx("div",{className:"text-sm text-center text-red-600 mt-2",children:v})]})}),S&&e.jsxs("div",{role:"status","aria-live":"polite",className:"fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg animate-fade-in z-50",children:[S,e.jsx("button",{onClick:()=>k(""),className:"ml-4 text-white/80 hover:text-white font-bold",children:"×"})]})]})}export{xe as default};

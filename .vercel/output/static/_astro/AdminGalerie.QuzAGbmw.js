import{j as e,I as j,B as c,D as de,a as ue,b as me,c as xe}from"./input.Ax_aeIQF.js";import{r as t}from"./index.Dy7WD_uu.js";import{S as U,a as M,b as R,c as z,d as u,T as De,e as Ae,f as ee,g as Ee,h as Pe,i as b}from"./select.BPMtuf4o.js";const Le=[5,10,20,50,100];function Me(){const[ae,$]=t.useState([]),[he,pe]=t.useState([]),[fe,ge]=t.useState([]),[je,le]=t.useState(!0),[v,te]=t.useState(""),[q,T]=t.useState("all"),[V,F]=t.useState("all"),[Y,x]=t.useState("all"),[H,h]=t.useState("all"),[J,p]=t.useState("all"),[f,se]=t.useState("all"),[ie,re]=t.useState(()=>new Date().toISOString().slice(0,10)),[be,D]=t.useState(!1),[g,_]=t.useState(null),[r,y]=t.useState({title:"",imageUrl:"",alt:"",description:"",uploadedBy:""}),[A,S]=t.useState(null),[E,N]=t.useState(""),[Z,P]=t.useState(null),[w,m]=t.useState(!1),[L,i]=t.useState(""),[O,K]=t.useState(""),[C,Q]=t.useState(1),[G,ve]=t.useState(10),[k,ye]=t.useState({key:"createdAt",dir:"desc"}),I=t.useRef();t.useEffect(()=>{Promise.all([fetch("/api/galerie-db").then(a=>a.json()),fetch("/api/service-db").then(a=>a.json()),fetch("/api/formation-db").then(a=>a.json()).then(a=>a.data)]).then(([a,l,s])=>{$(a),pe(l),ge(s),le(!1)}).catch(()=>le(!1))},[]),t.useEffect(()=>{if(O){const a=setTimeout(()=>K(""),2500);return()=>clearTimeout(a)}},[O]);function Se(a){if(f==="all"||!a)return!0;const l=new Date(a),s=new Date(ie);return isNaN(l)||isNaN(s)?!0:f==="day"?l.toISOString().slice(0,10)===s.toISOString().slice(0,10):f==="month"?l.getFullYear()===s.getFullYear()&&l.getMonth()===s.getMonth():f==="year"?l.getFullYear()===s.getFullYear():!0}const ne=[...ae.filter(a=>q!=="all"&&String(a.serviceId)!==q||V!=="all"&&String(a.formationId)!==V||Y!=="all"&&String(a.global)!==Y||H!=="all"&&String(a.servicesGlobal)!==H||J!=="all"&&String(a.formationsGlobal)!==J||!Se(a.createdAt)?!1:v?a.title?.toLowerCase().includes(v.toLowerCase())||a.description?.toLowerCase().includes(v.toLowerCase())||a.uploadedBy?.toLowerCase().includes(v.toLowerCase()):!0)].sort((a,l)=>{const{key:s,dir:o}=k;let n=a[s],d=l[s];return typeof n=="string"&&(n=n.toLowerCase()),typeof d=="string"&&(d=d.toLowerCase()),n==null&&(n=""),d==null&&(d=""),n<d?o==="asc"?-1:1:n>d?o==="asc"?1:-1:0}),W=ne.length,X=Math.max(1,Math.ceil(W/G)),ce=ne.slice((C-1)*G,C*G),Ne=()=>{_(null),y({title:"",imageUrl:"",alt:"",description:"",uploadedBy:""}),S(null),N(""),D(!0),i("")},we=a=>{_(a.id),y({title:a.title,imageUrl:a.imageUrl||"",alt:a.alt||"",description:a.description,uploadedBy:a.uploadedBy||""}),S(null),N(a.imageUrl||""),D(!0),i("")},oe=()=>{D(!1),_(null),y({title:"",imageUrl:"",alt:"",description:"",uploadedBy:""}),S(null),N(""),i("")},Ce=a=>{const l=a.target.files[0];if(l){if(!["image/jpeg","image/png","image/webp","image/avif"].includes(l.type)){i("Format d'image non autorisé (jpg, png, webp, avif)"),I.current.value="";return}if(l.size>5*1024*1024){i("Image trop volumineuse (max 5 Mo)"),I.current.value="";return}S(l),N(URL.createObjectURL(l))}},ke=()=>{S(null),N(""),y(a=>({...a,imageUrl:""})),I.current&&(I.current.value="")},B=a=>{const{name:l,value:s}=a.target;y(o=>({...o,[l]:s}))},Ie=async a=>{if(a.preventDefault(),w)return;if(m(!0),i(""),!r.title.trim()){i("Le titre est obligatoire."),m(!1);return}if(!r.alt.trim()){i("Le texte alternatif (accessibilité) est obligatoire."),m(!1);return}if(!r.description.trim()){i("La description est obligatoire."),m(!1);return}let l=r.imageUrl;if(A){const s=new FormData;s.append("file",A);const o=await fetch("/api/upload-galerie-image",{method:"POST",body:s});if(o.ok){const{filename:n}=await o.json();l=n}else{i("Erreur upload image"),m(!1);return}}try{const s=g?"PATCH":"POST",o=g?`/api/galerie-db?id=${g}`:"/api/galerie-db",n={...r,imageUrl:l};(await fetch(o,{method:s,headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).ok?(K(g?"Image modifiée !":"Image ajoutée !"),$(await fetch("/api/galerie-db").then(Fe=>Fe.json())),oe()):i("Erreur lors de l'enregistrement.")}catch{i("Erreur réseau.")}m(!1)},Te=async()=>{if(Z){m(!0),i("");try{(await fetch(`/api/galerie-db?id=${Z}`,{method:"DELETE"})).ok?(i("Image supprimée."),$(await fetch("/api/galerie-db").then(l=>l.json())),P(null)):i("Erreur lors de la suppression.")}catch{i("Erreur réseau.")}m(!1)}};return je?e.jsx("div",{className:"text-center py-12",children:"Chargement..."}):ae?e.jsxs("div",{className:"w-full max-w-6xl mx-auto px-2 md:px-0",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Galerie"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsx(j,{type:"text",placeholder:"Recherche... (titre, description, auteur)",value:v,onChange:a=>te(a.target.value),className:"max-w-xs"}),e.jsx(c,{onClick:Ne,variant:"default",className:"w-full sm:w-auto",children:"Ajouter"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4 items-center bg-gray-50 p-3 rounded-lg shadow-sm",children:[e.jsx(c,{type:"button",variant:"secondary",onClick:()=>{T("all"),F("all"),x("all"),h("all"),p("all"),se("all"),re(new Date().toISOString().slice(0,10)),te("")},children:"Réinitialiser"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-semibold",children:"Service"}),e.jsxs(U,{value:q,onValueChange:a=>{T(a),a!=="all"&&(x("0"),h("0"),p("0"))},children:[e.jsx(M,{className:"w-40",children:e.jsx(R,{placeholder:"Tous les services"})}),e.jsxs(z,{children:[e.jsx(u,{value:"all",children:"Tous les services"}),he.map(a=>e.jsx(u,{value:String(a.id),children:a.nom},a.id))]})]})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-semibold",children:"Formation"}),e.jsxs(U,{value:V,onValueChange:a=>{F(a),a!=="all"&&(x("0"),h("0"),p("0"))},children:[e.jsx(M,{className:"w-40",children:e.jsx(R,{placeholder:"Toutes les formations"})}),e.jsxs(z,{children:[e.jsx(u,{value:"all",children:"Toutes les formations"}),fe.map(a=>e.jsx(u,{value:String(a.id),children:a.titre},a.id))]})]})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-semibold",children:"Type d’image"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("label",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"radio",name:"globalType",value:"global",checked:Y==="1",onChange:()=>{x("1"),h("all"),p("all"),T("all"),F("all")}})," Global"]}),e.jsxs("label",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"radio",name:"globalType",value:"servicesGlobal",checked:H==="1",onChange:()=>{x("0"),h("1"),p("all"),F("all")}})," Services global"]}),e.jsxs("label",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"radio",name:"globalType",value:"formationsGlobal",checked:J==="1",onChange:()=>{x("0"),h("all"),p("1"),T("all")}})," Formations global"]})]})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-semibold",children:"Période"}),e.jsxs(U,{value:f,onValueChange:se,children:[e.jsx(M,{className:"w-32",children:e.jsx(R,{placeholder:"Période"})}),e.jsxs(z,{children:[e.jsx(u,{value:"all",children:"Toutes dates"}),e.jsx(u,{value:"day",children:"Jour"}),e.jsx(u,{value:"month",children:"Mois"}),e.jsx(u,{value:"year",children:"Année"})]})]})]}),f!=="all"&&e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("label",{className:"text-xs font-semibold",children:"Date"}),e.jsx(j,{type:"date",value:ie,onChange:a=>re(a.target.value),className:"w-36",min:"2000-01-01",max:"2100-12-31"})]})]}),e.jsxs(De,{children:[e.jsx(Ae,{children:e.jsx(ee,{children:[{key:"title",label:"Titre"},{key:"description",label:"Description"},{key:"uploadedBy",label:"Auteur"},{key:"createdAt",label:"Date"},{key:"actions",label:"Actions"}].map(a=>e.jsxs(Ee,{onClick:()=>a.key!=="actions"&&ye(l=>({key:a.key,dir:l.key===a.key&&l.dir==="asc"?"desc":"asc"})),className:a.key!=="actions"?"cursor-pointer select-none":"","aria-sort":k.key===a.key?k.dir==="asc"?"ascending":"descending":void 0,children:[a.label,k.key===a.key?k.dir==="asc"?" ▲":" ▼":null]},a.key))})}),e.jsx(Pe,{children:ce.length===0?e.jsx(ee,{children:e.jsx(b,{colSpan:5,children:"Aucune image enregistrée."})}):ce.map(a=>e.jsxs(ee,{children:[e.jsx(b,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[Array.isArray(a.images)&&a.images.length>0?a.images.slice(0,2).map((l,s)=>e.jsx("img",{src:l,alt:a.alt||(a.title?`Image galerie : ${a.title} (${s+1})`:`Image galerie ${s+1}`),className:"h-12 w-12 object-cover rounded shadow"},l+s)):a.imageUrl?e.jsx("img",{src:a.imageUrl,alt:a.alt||(a.title?`Image galerie : ${a.title}`:"Image galerie"),className:"h-12 w-12 object-cover rounded shadow"}):null,e.jsx("span",{children:a.title})]})}),e.jsx(b,{children:a.description}),e.jsx(b,{children:a.uploadedBy}),e.jsx(b,{children:a.createdAt?a.createdAt.slice(0,10):"-"}),e.jsxs(b,{children:[e.jsx(c,{variant:"outline",size:"sm",onClick:()=>we(a),children:"Éditer"}),e.jsx(c,{variant:"destructive",size:"sm",onClick:()=>P(a.id),children:"Supprimer"})]})]},a.id))})]}),e.jsxs("div",{className:"flex flex-wrap justify-between items-center mt-4 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:["Page ",C," / ",X]}),e.jsxs(U,{value:String(G),onValueChange:a=>{ve(Number(a)),Q(1)},children:[e.jsx(M,{className:"w-24 h-8 text-xs",children:e.jsx(R,{})}),e.jsx(z,{children:Le.map(a=>e.jsxs(u,{value:String(a),children:[a," / page"]},a))})]})]}),e.jsxs("div",{className:"flex gap-2",children:[C>1&&e.jsx(c,{type:"button",size:"sm",variant:"secondary",onClick:()=>Q(a=>Math.max(1,a-1)),"aria-label":"Page précédente",children:"Précédent"}),C<X&&e.jsx(c,{type:"button",size:"sm",variant:"secondary",onClick:()=>Q(a=>Math.min(X,a+1)),"aria-label":"Page suivante",children:"Suivant"})]}),e.jsxs("span",{className:"text-xs text-gray-500",children:[W," résultat",W>1?"s":""]})]}),e.jsx(de,{open:be,onOpenChange:D,children:e.jsxs(ue,{children:[e.jsx(me,{children:g?"Modifier l’image":"Ajouter une image"}),e.jsxs("form",{onSubmit:Ie,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Image"}),A||E?e.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[e.jsx("img",{src:A?E:E||void 0,alt:r.alt||(r.title?`Image galerie : ${r.title}`:"Image galerie"),className:"h-16 rounded shadow"}),e.jsx(c,{type:"button",variant:"destructive",size:"sm",onClick:ke,children:"Supprimer"})]}):null,e.jsx("input",{ref:I,type:"file",accept:"image/*",onChange:Ce,className:"block","aria-label":"Image de la galerie"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Titre"}),e.jsx(j,{name:"title",value:r.title,onChange:B,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Texte alternatif (accessibilité)"}),e.jsx(j,{name:"alt",value:r.alt,onChange:B,required:!0,maxLength:180,placeholder:"Ex : Maquillage mariée bohème à Annecy, ambiance champêtre, bouquet, robe fluide…"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Auteur"}),e.jsx(j,{name:"uploadedBy",value:r.uploadedBy,onChange:B})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Description"}),e.jsx(j,{name:"description",value:r.description,onChange:B,required:!0})]})]}),e.jsxs(xe,{children:[e.jsx(c,{type:"button",variant:"secondary",onClick:oe,disabled:w,children:"Annuler"}),e.jsx(c,{type:"submit",variant:"default",disabled:w,children:g?"Enregistrer":"Ajouter"})]}),L&&e.jsx("div",{className:"text-sm text-center text-red-600 mt-2",children:L})]})]})}),e.jsx(de,{open:!!Z,onOpenChange:a=>{a||P(null)},children:e.jsxs(ue,{children:[e.jsx(me,{children:"Supprimer l’image ?"}),e.jsx("div",{children:"Cette action est irréversible."}),e.jsxs(xe,{children:[e.jsx(c,{type:"button",variant:"secondary",onClick:()=>P(null),disabled:w,children:"Annuler"}),e.jsx(c,{type:"button",variant:"destructive",onClick:Te,disabled:w,children:"Supprimer"})]}),L&&e.jsx("div",{className:"text-sm text-center text-red-600 mt-2",children:L})]})}),O&&e.jsxs("div",{role:"status","aria-live":"polite",className:"fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg animate-fade-in z-50",children:[O,e.jsx("button",{onClick:()=>K(""),className:"ml-4 text-white/80 hover:text-white font-bold",children:"×"})]})]}):e.jsx("div",{className:"text-center py-12 text-red-600",children:"Erreur de chargement de la galerie."})}export{Me as default};

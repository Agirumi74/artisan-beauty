import{j as s,I as d,B as c,D as me,a as xe,b as ge,c as he}from"./input.Ax_aeIQF.js";import{r as l}from"./index.Dy7WD_uu.js";import{S as R,a as M,b as V,c as $,d as g,T as Oe,e as Le,f as W,g as ze,h as Pe,i as h}from"./select.BPMtuf4o.js";const Re=[5,10,20,50,100],Me=["mariée","shooting","enfant","soirée","FX","mode","homme","beauté","artistique","initiation"];function Be(){const[p,q]=l.useState([]),[pe,Y]=l.useState(!0),[b,fe]=l.useState(""),[J,ee]=l.useState("all"),[G,je]=l.useState("all"),[B,ve]=l.useState("all"),se=e=>{fe(e),v(1)},te=e=>{je(e),v(1)},ae=e=>{ve(e),v(1)},[be,D]=l.useState(!1),[f,U]=l.useState(null),[a,u]=l.useState({nom:"",description:"",prix:0,duree:"",isActive:!0,isFeatured:!1,image:"",imageAlt:"",tags:[],steps:[],slug:"",imageName:""}),[ie,y]=l.useState(""),[le,N]=l.useState(""),[E,S]=l.useState(null),[I,k]=l.useState(""),[H,O]=l.useState(null),[A,m]=l.useState(!1),[L,n]=l.useState(""),[z,_]=l.useState(""),[w,v]=l.useState(1),[P,ye]=l.useState(10),C=l.useRef();l.useEffect(()=>{fetch("/api/service-db").then(e=>e.json()).then(e=>{q(e),Y(!1)}).catch(()=>Y(!1))},[]),l.useEffect(()=>{if(z){const e=setTimeout(()=>_(""),2500);return()=>clearTimeout(e)}},[z]);const[F,Ne]=l.useState({key:"nom",dir:"asc"}),re=[...p].sort((e,t)=>{const{key:i,dir:j}=F;let o=e[i],r=t[i];return typeof o=="string"&&(o=o.toLowerCase()),typeof r=="string"&&(r=r.toLowerCase()),o==null&&(o=""),r==null&&(r=""),o<r?j==="asc"?-1:1:o>r?j==="asc"?1:-1:0}).filter(e=>{let t=Array.isArray(e.tags)?e.tags:typeof e.tags=="string"&&e.tags?(()=>{try{return JSON.parse(e.tags)}catch{return[]}})():[];return J!=="all"&&!t.includes(J)||G!=="all"&&String(e.isActive?1:0)!==G||B!=="all"&&String(e.isFeatured?1:0)!==B?!1:b?e.nom?.toLowerCase().includes(b.toLowerCase())||e.description?.toLowerCase().includes(b.toLowerCase())||t.join(" ").toLowerCase().includes(b.toLowerCase()):!0}),Se=()=>{U(null),u({nom:"",description:"",prix:0,duree:"",isActive:!0,isFeatured:!1,image:"",imageAlt:"",tags:[],steps:[],slug:""}),N(""),y(""),S(null),k(""),D(!0)},ke=e=>{U(e.id),u({nom:e.nom,description:e.description,prix:e.prix,duree:e.duree||"",isActive:!!e.isActive,isFeatured:!!e.isFeatured,image:e.image||"",imageAlt:e.imageAlt||"",tags:Array.isArray(e.tags)?e.tags:typeof e.tags=="string"&&e.tags?JSON.parse(e.tags):[],steps:Array.isArray(e.steps)?e.steps:typeof e.steps=="string"&&e.steps?JSON.parse(e.steps):[],slug:e.slug||""}),N(""),y(""),S(null),k(e.image?`/assets/${e.image.replace(/^.*[\\/]/,"")}`:""),D(!0)},ne=()=>{D(!1),U(null),u({nom:"",description:"",prix:0,duree:"",isActive:!0,isFeatured:!1,image:"",imageAlt:"",tags:[],steps:[]}),N(""),y(""),S(null),k(""),n("")},ce=e=>{e.preventDefault();const t=ie.trim();!t||a.steps.includes(t)||(u(i=>({...i,steps:[...i.steps,t]})),y(""))},Ae=e=>{u(t=>({...t,steps:t.steps.filter(i=>i!==e)}))},oe=e=>{e.preventDefault();const t=le.trim();!t||a.tags.includes(t)||(u(i=>({...i,tags:[...i.tags,t]})),N(""))},we=e=>{u(t=>({...t,tags:t.tags.filter(i=>i!==e)}))},Ce=e=>{const t=e.target.files[0];if(t){if(!["image/jpeg","image/png","image/webp","image/avif"].includes(t.type)){n("Format d'image non autorisé (jpg, png, webp, avif)"),C.current.value="";return}if(t.size>5*1024*1024){n("Image trop volumineuse (max 5 Mo)"),C.current.value="";return}S(t),k(URL.createObjectURL(t))}},Fe=()=>{S(null),k(""),u(e=>({...e,image:""})),C.current&&(C.current.value="")};function K(e){return e.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"")}const x=e=>{const{name:t,value:i,type:j,checked:o}=e.target;u(r=>t==="nom"&&(!r.slug||r.slug===K(r.nom))?{...r,nom:i,slug:K(i)}:t==="imageName"?{...r,imageName:K(i)}:{...r,[t]:j==="checkbox"?o:j==="number"?Number(i):i})},Te=async e=>{if(e.preventDefault(),A)return;if(m(!0),n(""),!a.nom.trim()){n("Le nom est obligatoire."),m(!1);return}if(!a.slug.trim()||!/^[a-z0-9\-]+$/.test(a.slug)){n("Slug invalide (lettres, chiffres, tirets)."),m(!1);return}if(a.prix<=0){n("Le prix doit être supérieur à 0."),m(!1);return}if(p.some(i=>i.slug===a.slug&&i.id!==f)){n("Ce slug existe déjà, choisissez-en un autre."),m(!1);return}try{let i=a.image;if(E){const T=new FormData;T.append("file",E),a.imageName&&T.append("name",a.imageName);const ue=await fetch("/api/upload-service-image",{method:"POST",body:T});if(ue.ok){const{filename:Ie}=await ue.json();i=Ie}else{n("Erreur upload image"),m(!1);return}}const j=f?"PATCH":"POST",o=f?`/api/service-db?id=${f}`:"/api/service-db",r={...a,image:i,isActive:a.isActive?1:0,isFeatured:a.isFeatured?1:0};(await fetch(o,{method:j,headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).ok?(_(f?"Service modifié !":"Service ajouté !"),q(await fetch("/api/service-db").then(T=>T.json())),ne()):n("Erreur lors de l'enregistrement.")}catch{n("Erreur réseau.")}m(!1)},De=async()=>{if(H){m(!0),n("");try{(await fetch(`/api/service-db?id=${H}`,{method:"DELETE"})).ok?(n("Service supprimé."),q(await fetch("/api/service-db").then(t=>t.json())),O(null)):n("Erreur lors de la suppression.")}catch{n("Erreur réseau.")}m(!1)}};if(pe)return s.jsx("div",{className:"text-center py-12",children:"Chargement..."});if(!p)return s.jsx("div",{className:"text-center py-12 text-red-600",children:"Erreur de chargement des services."});const Ee=Array.from(new Set(p.flatMap(e=>{if(Array.isArray(e.tags))return e.tags;if(typeof e.tags=="string"&&e.tags)try{return JSON.parse(e.tags)}catch{return[]}return[]}).filter(Boolean))),X={total:p.length,actifs:p.filter(e=>e.isActive).length,vedettes:p.filter(e=>e.isFeatured).length},Z=re.length,Q=Math.max(1,Math.ceil(Z/P)),de=re.slice((w-1)*P,w*P);return s.jsxs("div",{className:"w-full max-w-6xl mx-auto px-2 md:px-0",children:[s.jsxs("div",{className:"flex flex-wrap gap-4 mb-4 items-center bg-blue-50 p-3 rounded-lg shadow-sm",children:[s.jsxs("span",{className:"font-semibold",children:["Total : ",X.total]}),s.jsxs("span",{className:"text-green-700",children:["Actifs : ",X.actifs]}),s.jsxs("span",{className:"text-yellow-700",children:["Vedettes : ",X.vedettes]})]}),s.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4",children:[s.jsx("h2",{className:"text-2xl font-bold",children:"Services"}),s.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[s.jsx(d,{type:"text",placeholder:"Recherche... (nom, description, tag)",value:b,onChange:e=>se(e.target.value),className:"max-w-xs"}),s.jsx(c,{onClick:Se,variant:"default",className:"w-full sm:w-auto",children:"Ajouter"})]})]}),s.jsxs("div",{className:"flex flex-wrap gap-2 mb-4 items-center bg-gray-50 p-3 rounded-lg shadow-sm",children:[s.jsx(c,{type:"button",variant:"secondary",onClick:()=>{ee("all"),te("all"),ae("all"),se("")},children:"Réinitialiser"}),s.jsxs("div",{className:"flex flex-col gap-1",children:[s.jsx("label",{className:"text-xs font-semibold",children:"Tag"}),s.jsxs(R,{value:J,onValueChange:ee,children:[s.jsx(M,{className:"w-40",children:s.jsx(V,{placeholder:"Tous les tags"})}),s.jsxs($,{children:[s.jsx(g,{value:"all",children:"Tous les tags"}),Ee.map(e=>s.jsx(g,{value:e,children:e},e))]})]})]}),s.jsxs("div",{className:"flex flex-col gap-1",children:[s.jsx("label",{className:"text-xs font-semibold",children:"Actif"}),s.jsxs(R,{value:G,onValueChange:te,children:[s.jsx(M,{className:"w-28",children:s.jsx(V,{placeholder:"Tous"})}),s.jsxs($,{children:[s.jsx(g,{value:"all",children:"Tous"}),s.jsx(g,{value:"1",children:"Oui"}),s.jsx(g,{value:"0",children:"Non"})]})]})]}),s.jsxs("div",{className:"flex flex-col gap-1",children:[s.jsx("label",{className:"text-xs font-semibold",children:"Vedette"}),s.jsxs(R,{value:B,onValueChange:ae,children:[s.jsx(M,{className:"w-28",children:s.jsx(V,{placeholder:"Tous"})}),s.jsxs($,{children:[s.jsx(g,{value:"all",children:"Tous"}),s.jsx(g,{value:"1",children:"Oui"}),s.jsx(g,{value:"0",children:"Non"})]})]})]})]}),s.jsxs(Oe,{children:[s.jsx(Le,{children:s.jsx(W,{children:[{key:"nom",label:"Nom"},{key:"description",label:"Description"},{key:"prix",label:"Prix"},{key:"tags",label:"Tags"},{key:"duree",label:"Durée"},{key:"isActive",label:"Active"},{key:"isFeatured",label:"Vedette"},{key:"actions",label:"Actions"}].map(e=>s.jsxs(ze,{onClick:()=>e.key!=="actions"&&Ne(t=>({key:e.key,dir:t.key===e.key&&t.dir==="asc"?"desc":"asc"})),className:e.key!=="actions"?"cursor-pointer select-none":"","aria-sort":F.key===e.key?F.dir==="asc"?"ascending":"descending":void 0,children:[e.label,F.key===e.key?F.dir==="asc"?" ▲":" ▼":null]},e.key))})}),s.jsx(Pe,{children:de.length===0?s.jsx(W,{children:s.jsx(h,{colSpan:8,children:"Aucun service enregistré."})}):de.map(e=>s.jsxs(W,{children:[s.jsx(h,{children:e.nom}),s.jsx(h,{children:e.description}),s.jsxs(h,{children:[e.prix," €"]}),s.jsx(h,{children:Array.isArray(e.tags)?e.tags.join(", "):typeof e.tags=="string"&&e.tags?(()=>{try{return JSON.parse(e.tags).join(", ")}catch{return e.tags}})():""}),s.jsx(h,{children:e.duree||(e.durationMinutes?e.durationMinutes+" min":"")}),s.jsx(h,{children:e.isActive?"Oui":"Non"}),s.jsx(h,{children:e.isFeatured?"Oui":"Non"}),s.jsxs(h,{children:[s.jsx(c,{variant:"outline",size:"sm",onClick:()=>ke(e),children:"Éditer"}),s.jsx(c,{variant:"destructive",size:"sm",onClick:()=>O(e.id),children:"Supprimer"})]})]},e.id))})]}),s.jsxs("div",{className:"flex flex-wrap justify-between items-center mt-4 gap-2",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("span",{className:"text-xs text-gray-500",children:["Page ",w," / ",Q]}),s.jsxs(R,{value:String(P),onValueChange:e=>{ye(Number(e)),v(1)},children:[s.jsx(M,{className:"w-24 h-8 text-xs",children:s.jsx(V,{})}),s.jsx($,{children:Re.map(e=>s.jsxs(g,{value:String(e),children:[e," / page"]},e))})]})]}),s.jsxs("div",{className:"flex gap-2",children:[w>1&&s.jsx(c,{type:"button",size:"sm",variant:"secondary",onClick:()=>v(e=>Math.max(1,e-1)),"aria-label":"Page précédente",children:"Précédent"}),w<Q&&s.jsx(c,{type:"button",size:"sm",variant:"secondary",onClick:()=>v(e=>Math.min(Q,e+1)),"aria-label":"Page suivante",children:"Suivant"})]}),s.jsxs("span",{className:"text-xs text-gray-500",children:[Z," résultat",Z>1?"s":""]})]}),s.jsx(me,{open:be,onOpenChange:D,children:s.jsxs(xe,{children:[s.jsx(ge,{children:f?"Modifier le service":"Ajouter un service"}),s.jsxs("form",{onSubmit:Te,className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{className:"md:col-span-2",children:[s.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Étapes du service"}),s.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:a.steps.map((e,t)=>s.jsxs("span",{className:"inline-flex items-center bg-blue-100 rounded px-2 py-0.5 text-xs",children:[e,s.jsx("button",{type:"button",className:"ml-1 text-red-500 hover:text-red-700",onClick:()=>Ae(e),"aria-label":`Supprimer ${e}`,children:"×"})]},e+t))}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(d,{value:ie,onChange:e=>y(e.target.value),placeholder:"Ajouter une étape...",onKeyDown:e=>{e.key==="Enter"&&(e.preventDefault(),ce(e))},"aria-label":"Ajouter une étape"}),s.jsx(c,{type:"button",size:"sm",variant:"secondary",onClick:ce,children:"Ajouter"})]})]}),s.jsxs("div",{className:"md:col-span-2",children:[s.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Tags"}),s.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:a.tags.map(e=>s.jsxs("span",{className:"inline-flex items-center bg-gray-200 rounded px-2 py-0.5 text-xs",children:[e,s.jsx("button",{type:"button",className:"ml-1 text-red-500 hover:text-red-700",onClick:()=>we(e),"aria-label":`Supprimer ${e}`,children:"×"})]},e))}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(d,{value:le,onChange:e=>N(e.target.value),placeholder:"Ajouter un tag...",list:"tag-suggestions",onKeyDown:e=>{e.key==="Enter"&&(e.preventDefault(),oe(e))},"aria-label":"Ajouter un tag"}),s.jsx(c,{type:"button",size:"sm",variant:"secondary",onClick:oe,children:"Ajouter"})]}),s.jsx("datalist",{id:"tag-suggestions",children:Me.filter(e=>!a.tags.includes(e)).map(e=>s.jsx("option",{value:e},e))})]}),s.jsxs("div",{className:"md:col-span-2",children:[s.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Image"}),E||I?s.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[s.jsx("img",{src:E?I:I||void 0,alt:"Preview",className:"h-16 rounded shadow"}),s.jsx(c,{type:"button",variant:"destructive",size:"sm",onClick:Fe,children:"Supprimer"})]}):null,s.jsx("input",{ref:C,type:"file",accept:"image/*",onChange:Ce,className:"block","aria-label":"Image du service"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Nom de l’image (optionnel, sans extension)"}),s.jsx(d,{name:"imageName",value:a.imageName,onChange:x,placeholder:"ex: shooting-mode-ete"}),s.jsx("span",{className:"text-xs text-gray-400",children:"Le nom sera utilisé pour le fichier uploadé (slugifié)."})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Texte alternatif (accessibilité)"}),s.jsx(d,{name:"imageAlt",value:a.imageAlt,onChange:x,placeholder:"Description de l'image"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Nom"}),s.jsx(d,{name:"nom",value:a.nom,onChange:x,required:!0})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Slug (URL)"}),s.jsx(d,{name:"slug",value:a.slug,onChange:x,required:!0,pattern:"[a-z0-9\\-]+"}),s.jsx("span",{className:"text-xs text-gray-400",children:"Généré automatiquement, modifiable."})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Prix (€)"}),s.jsx(d,{name:"prix",type:"number",value:a.prix,onChange:x,required:!0,min:0,step:.01})]}),s.jsxs("div",{className:"md:col-span-2",children:[s.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Description"}),s.jsx(d,{name:"description",value:a.description,onChange:x,required:!0})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-xs font-semibold mb-1",children:"Durée"}),s.jsx(d,{name:"duree",value:a.duree,onChange:x})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"checkbox",name:"isActive",checked:a.isActive,onChange:x,id:"isActive"}),s.jsx("label",{htmlFor:"isActive",className:"text-xs",children:"Actif"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"checkbox",name:"isFeatured",checked:a.isFeatured,onChange:x,id:"isFeatured"}),s.jsx("label",{htmlFor:"isFeatured",className:"text-xs",children:"Vedette"})]})]}),s.jsxs(he,{children:[s.jsx(c,{type:"button",variant:"secondary",onClick:ne,disabled:A,children:"Annuler"}),s.jsx(c,{type:"submit",variant:"default",disabled:A,children:f?"Enregistrer":"Ajouter"})]}),L&&s.jsx("div",{className:"text-sm text-center text-red-600 mt-2",children:L})]})]})}),s.jsx(me,{open:!!H,onOpenChange:e=>{e||O(null)},children:s.jsxs(xe,{children:[s.jsx(ge,{children:"Supprimer le service ?"}),s.jsx("div",{children:"Cette action est irréversible."}),s.jsxs(he,{children:[s.jsx(c,{type:"button",variant:"secondary",onClick:()=>O(null),disabled:A,children:"Annuler"}),s.jsx(c,{type:"button",variant:"destructive",onClick:De,disabled:A,children:"Supprimer"})]}),L&&s.jsx("div",{className:"text-sm text-center text-red-600 mt-2",children:L})]})}),z&&s.jsxs("div",{role:"status","aria-live":"polite",className:"fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg animate-fade-in z-50",children:[z,s.jsx("button",{onClick:()=>_(""),className:"ml-4 text-white/80 hover:text-white font-bold",children:"×"})]})]})}export{Be as default};

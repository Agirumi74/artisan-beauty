---
import Layout from '@layouts/Layout.astro';
import db from '@lib/db';

// Get all services for selection
let services: any[] = [];
let formations: any[] = [];

try {
  services = db.prepare('SELECT id, nom, prix, duree FROM services WHERE isActive = 1 ORDER BY nom ASC').all();
  formations = db.prepare('SELECT id, titre, prix, duree FROM formations WHERE isActive = 1 ORDER BY titre ASC').all();
} catch (error) {
  console.error('Database error:', error);
}

const url = new URL(Astro.request.url);
const serviceSlug = url.searchParams.get('service');
const formationSlug = url.searchParams.get('formation');

let preselectedService: any = null;
let preselectedFormation: any = null;

if (serviceSlug) {
  preselectedService = db.prepare('SELECT * FROM services WHERE slug = ?').get(serviceSlug);
}
if (formationSlug) {
  preselectedFormation = db.prepare('SELECT * FROM formations WHERE slug = ?').get(formationSlug);
}
---
<Layout>
  <section class="container mx-auto py-12">
    <div class="max-w-2xl mx-auto">
      <h1 class="text-3xl font-bold mb-6 text-pink-700 text-center">
        {preselectedService ? `Réserver le service : ${preselectedService.nom}` : preselectedFormation ? `Inscription à la formation : ${preselectedFormation.titre}` : 'Réserver une prestation'}
      </h1>
      {(preselectedService || preselectedFormation) && (
        <div class="bg-pink-50 rounded-xl shadow p-6 mb-8 flex gap-6 items-center">
          <img src={preselectedService?.image || preselectedFormation?.image} alt={preselectedService?.nom || preselectedFormation?.titre} class="w-32 h-32 object-cover rounded-xl border-2 border-pink-200" loading="lazy" />
          <div>
            <div class="font-bold text-lg text-pink-700 mb-1">{preselectedService?.nom || preselectedFormation?.titre}</div>
            <div class="text-gray-600 mb-1">{preselectedService?.categorie || preselectedFormation?.categorie}</div>
            <div class="text-gray-700 mb-2 line-clamp-2">{preselectedService?.description || preselectedFormation?.description}</div>
            <div class="font-bold text-pink-700 text-xl">{preselectedService?.prix || preselectedFormation?.prix} €</div>
          </div>
        </div>
      )}
      <form id="reservation-form" class="bg-white rounded shadow p-8 flex flex-col gap-4" on:submit|preventDefault={async (e: SubmitEvent) => {
        const form = e.target as HTMLFormElement;
        const submitBtn = form.querySelector('button[type=submit]') as HTMLButtonElement;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Envoi en cours...';
        const data = {
          userId: (form.elements.namedItem('userId') as HTMLInputElement)?.value,
          serviceId: service ? service.id : null,
          formationId: formation ? formation.id : null,
          date: (form.elements.namedItem('date') as HTMLInputElement)?.value,
          time: (form.elements.namedItem('time') as HTMLInputElement)?.value,
          status: 'pending',
          notes: (form.elements.namedItem('notes') as HTMLInputElement)?.value
        };
        const res = await fetch('/api/reservation-db', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) {
          const result = await res.json();
          window.location.href = `/reservations/confirmation?id=${result.id}`;
        } else {
          alert('Erreur lors de la réservation.');
        }
        submitBtn.disabled = false;
        submitBtn.textContent = service ? 'Valider la réservation' : 'Valider l’inscription';
      }}>
        <label class="font-semibold">Votre nom (obligatoire)
          <input type="text" name="userId" required class="input input-bordered w-full" placeholder="Votre nom complet" />
        </label>
        <label class="font-semibold">Date souhaitée
          <input type="date" name="date" required class="input input-bordered w-full" min={new Date().toISOString().split('T')[0]} />
        </label>
        <label class="font-semibold">Heure souhaitée
          <input type="time" name="time" required class="input input-bordered w-full" />
        </label>
        <label class="font-semibold">Notes complémentaires
          <textarea name="notes" class="input input-bordered w-full" placeholder="Précisez un besoin, une allergie, etc."></textarea>
        </label>
        <button type="submit" class="bg-pink-700 text-white px-6 py-3 rounded hover:bg-pink-800 transition">{preselectedService ? 'Valider la réservation' : 'Valider l’inscription'}</button>
        <div id="reservation-success" style="display:none" class="bg-green-100 text-green-800 p-4 rounded mt-4 text-center font-semibold">Votre réservation a bien été enregistrée ! Vous recevrez une confirmation par email.</div>
      </form>
    </div>
  </section>

  <script>
    // Handle form submission
    const form = document.getElementById('reservation-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Envoi en cours...';
      
      // Get form data
      const formData = new FormData(form);
      const data = {
        nom: formData.get('nom') || formData.get('userId'),
        prenom: formData.get('prenom') || '',
        email: formData.get('email') || '',
        telephone: formData.get('telephone') || '',
        serviceId: formData.get('serviceId') || null,
        formationId: formData.get('formationId') || null,
        date: formData.get('date'),
        time: formData.get('time'),
        notes: formData.get('notes'),
        status: 'pending'
      };

      try {
        const response = await fetch('/api/reservation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          const result = await response.json();
          window.location.href = `/reservations/confirmation?id=${result.id}`;
        } else {
          alert('Erreur lors de la réservation. Veuillez réessayer.');
        }
      } catch (error) {
        alert('Une erreur est survenue. Veuillez réessayer ou nous contacter directement.');
      }
      
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    });
  </script>
</Layout>

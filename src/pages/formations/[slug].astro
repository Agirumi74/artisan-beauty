---
import Layout from '@layouts/Layout.astro';
import db from '@lib/db';
import FormationFaq from '../../components/FormationFaq.astro';
import FormationAvis from '../../components/FormationAvis.astro';
import FormationGallery from '../../components/FormationGallery.astro';
export async function getStaticPaths() {
  const formations = db.prepare('SELECT slug FROM formations').all() as { slug: string }[];
  return formations.map(f => ({ params: { slug: String(f.slug) } }));
}
const { slug } = Astro.params;
let formation: import('../../types/Formation').Formation | null = null;
let faqs: any[] = [];
let avis: any[] = [];
let images: any[] = [];
try {
  formation = db.prepare('SELECT * FROM formations WHERE slug = ?').get(slug) as import('../../types/Formation').Formation;
  if (formation) {
    if (typeof formation.tags === 'string') formation.tags = JSON.parse(formation.tags);
    if (typeof formation.steps === 'string') formation.steps = JSON.parse(formation.steps);
    faqs = db.prepare('SELECT * FROM faq WHERE formationsGlobal = 1 OR formationId = ? ORDER BY id ASC').all(formation.id);
    avis = db.prepare('SELECT * FROM avis WHERE formationsGlobal = 1 OR formationId = ? ORDER BY id ASC').all(formation.id);
    images = db.prepare('SELECT * FROM galerie WHERE formationsGlobal = 1 OR formationId = ? ORDER BY id ASC').all(formation.id);
  }
} catch (e) {
  formation = null;
}
---
<Layout>
  <!-- Hero Section -->
  <section class="section-luxury-hero">
    <div class="container mx-auto px-4">
      {formation && formation.titre ? (
        <div class="card-luxury hover-lift p-8 max-w-6xl mx-auto">
          <div class="flex flex-col lg:flex-row gap-8 items-start">
            {formation.image && (
              <div class="w-full lg:w-2/5 image-overlay-luxury rounded-2xl overflow-hidden">
                <img 
                  src={formation.image} 
                  alt={formation.imageAlt || formation.titre} 
                  class="w-full h-80 object-cover transition-transform duration-500"
                  loading="lazy" 
                />
              </div>
            )}
            <div class="flex-1 space-y-6">
              <div class="space-y-4">
                <h1 class="text-hero font-heading shimmer-text flex items-center gap-3">
                  {formation.icon && <span class={`inline-block icon-${formation.icon} text-4xl text-luxury-primary`} aria-hidden="true"></span>}
                  {formation.titre}
                </h1>
                
                {/* Status badges */}
                <div class="flex gap-3 flex-wrap">
                  {formation.isFeatured && (
                    <span class="glass-morphism px-4 py-2 rounded-full text-sm font-accent text-luxury-primary border border-luxury">
                      ‚≠ê Formation vedette
                    </span>
                  )}
                  {(!formation.isActive) && (
                    <span class="bg-luxury-neutral px-4 py-2 rounded-full text-sm font-accent text-luxury-light border border-luxury">
                      Inactif
                    </span>
                  )}
                  {formation.certification && (
                    <span class="bg-gradient-luxury-primary text-brand-ivory px-4 py-2 rounded-full text-sm font-accent uppercase tracking-wider">
                      üéì Certifiante
                    </span>
                  )}
                </div>
                
                {/* Category and duration tags */}
                <div class="flex gap-3 mb-6 flex-wrap">
                  {formation.categorie && (
                    <span class="bg-luxury-primary text-brand-ivory px-4 py-2 rounded-full text-sm font-accent uppercase tracking-wider">
                      {formation.categorie}
                    </span>
                  )}
                  {formation.duree && (
                    <span class="bg-luxury-accent text-luxury-dark px-4 py-2 rounded-full text-sm font-accent">
                      ‚è±Ô∏è {formation.duree}
                    </span>
                  )}
                  {formation.durationMinutes && (
                    <span class="bg-luxury-accent text-luxury-dark px-4 py-2 rounded-full text-sm font-accent">
                      {formation.durationMinutes} min
                    </span>
                  )}
                  {formation.niveau && (
                    <span class="glass-morphism-strong px-4 py-2 rounded-full text-sm font-accent text-luxury-primary">
                      üìà {formation.niveau}
                    </span>
                  )}
                </div>

                {/* Tags */}
                {formation.tags && formation.tags.length > 0 && (
                  <div class="flex gap-2 flex-wrap">
                    {formation.tags.map(tag => (
                      <span class="glass-morphism-strong px-3 py-1 rounded-full text-xs font-body text-luxury-primary">
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
                
                <p class="text-subtitle font-body leading-relaxed">{formation.description}</p>
                
                {formation.content && (
                  <div class="bg-luxury-neutral p-6 rounded-xl border border-luxury">
                    <h3 class="font-heading text-lg text-luxury-primary mb-2">Programme de formation</h3>
                    <p class="font-body text-luxury-dark">{formation.content}</p>
                  </div>
                )}
                
                {formation.prerequis && (
                  <div class="card-luxury-featured p-6">
                    <h3 class="font-heading text-lg text-luxury-primary mb-3">Pr√©requis</h3>
                    <p class="font-body text-luxury-dark">{formation.prerequis}</p>
                  </div>
                )}
                
                {formation.objectifs && (
                  <div class="bg-luxury-accent p-6 rounded-xl border border-luxury">
                    <h3 class="font-heading text-lg text-luxury-primary mb-3">Objectifs p√©dagogiques</h3>
                    <p class="font-body text-luxury-dark">{formation.objectifs}</p>
                  </div>
                )}
                
                {formation.notes && (
                  <div class="bg-luxury-champagne p-4 rounded-lg border border-luxury">
                    <h4 class="font-accent text-sm text-luxury-primary mb-1 uppercase tracking-wider">Notes importantes</h4>
                    <p class="font-body text-sm text-luxury-light">{formation.notes}</p>
                  </div>
                )}
                
                {formation.steps && formation.steps.length > 0 && (
                  <div class="card-luxury p-6">
                    <h3 class="font-heading text-lg text-luxury-primary mb-4">D√©roulement de la formation</h3>
                    <ol class="space-y-3">
                      {formation.steps.map((step, index) => (
                        <li class="flex items-start gap-3">
                          <span class="bg-gradient-luxury-primary text-brand-ivory w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold flex-shrink-0 mt-0.5">
                            {index + 1}
                          </span>
                          <span class="font-body text-luxury-dark">{step}</span>
                        </li>
                      ))}
                    </ol>
                  </div>
                )}

                {formation.certification && (
                  <div class="gradient-overlay-luxury card-luxury p-6">
                    <div class="flex items-center gap-3 mb-2">
                      <span class="text-2xl">üèÜ</span>
                      <h3 class="font-heading text-lg text-luxury-primary">Certification</h3>
                    </div>
                    <p class="font-body text-luxury-dark">{formation.certification}</p>
                  </div>
                )}
              </div>
              
              {/* Pricing and CTA */}
              <div class="flex flex-col sm:flex-row items-start sm:items-center gap-6 pt-6 border-t border-luxury">
                <div class="font-heading text-4xl shimmer-text">{formation.prix} ‚Ç¨</div>
                <a 
                  href={`/reservations?formation=${formation.slug}`} 
                  class="btn-luxury-primary btn-shine hover-lift-gentle animate-pulse-glow"
                >
                  S'inscrire √† cette formation
                </a>
              </div>
            </div>
          </div>
          
          {/* Gallery Section */}
          {images && images.length > 0 && (
            <div class="mt-12 pt-8 border-t border-luxury">
              <h2 class="text-headline font-heading text-luxury-primary mb-6 text-center">Galerie</h2>
              <FormationGallery images={images} />
            </div>
          )}
        </div>
      ) : (
        <div class="card-luxury p-8 text-center max-w-md mx-auto">
          <div class="text-warning-luxury text-lg font-accent uppercase tracking-wider mb-2">Formation introuvable</div>
          <p class="font-body text-luxury-light">La formation demand√©e n'existe pas ou a √©t√© supprim√©e.</p>
        </div>
      )}
    </div>
  </section>

  {formation && formation.titre && (
    <>
      {/* Reviews Section */}
      <section class="section-luxury">
        <div class="container mx-auto px-4">
          <div class="text-center mb-12">
            <h2 class="text-headline font-heading text-luxury-primary mb-4">Avis sur cette formation</h2>
            <div class="luxury-divider"></div>
          </div>
          <FormationAvis avis={avis} />
        </div>
      </section>

      {/* FAQ Section */}
      <section class="section-luxury-accent">
        <div class="container mx-auto px-4">
          <FormationFaq faqs={faqs} />
        </div>
      </section>
    </>
  )}
</Layout>

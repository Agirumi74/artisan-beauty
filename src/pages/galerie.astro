---
import Layout from '../layouts/Layout.astro';
import db from '../lib/db';

// R√©cup√©ration des services et images c√¥t√© serveur Astro
type Service = {
  id: number;
  nom: string;
};
type GalerieImage = {
  id: number;
  imageUrl: string;
  title: string;
  description?: string;
  serviceId?: number;
  servicesGlobal?: number;
};

let services: Service[] = [];
let galerie: GalerieImage[] = [];

try {
  services = db.prepare('SELECT id, nom FROM services ORDER BY nom ASC').all();
  galerie = db.prepare('SELECT * FROM galerie ORDER BY createdAt DESC').all();
} catch (error) {
  console.error('Database error:', error);
}
---


<Layout>

  <!-- Luxury Hero Section -->
  <section class="section-luxury-hero relative min-h-[60vh] flex items-center overflow-hidden">
    <!-- Background Image -->
    <img 
      src="/assets/shooting-annecy.jpg" 
      alt="Galerie Maquillage shooting √† Annecy" 
      class="absolute inset-0 w-full h-full object-cover opacity-20" 
      loading="lazy" 
    />
    
    <!-- Background Decorative Elements -->
    <div class="absolute top-20 left-10 w-40 h-40 bg-luxury-primary/10 rounded-full blur-3xl animate-luxury-fade-in"></div>
    <div class="absolute bottom-20 right-10 w-60 h-60 bg-luxury-secondary/10 rounded-full blur-3xl animate-luxury-fade-in" style="animation-delay: 0.5s;"></div>
    <div class="absolute top-1/3 right-1/4 w-20 h-20 bg-luxury-accent/20 rounded-full blur-2xl"></div>
    
    <div class="container mx-auto px-6 lg:px-8 relative z-10 text-center">
      <div class="animate-luxury-slide-in">
        <div class="font-accent text-luxury-primary uppercase tracking-widest text-sm mb-4">
          Portfolio ‚Ä¢ Inspiration
        </div>
        
        <h1 class="text-hero font-heading mb-6 leading-tight">
          Galerie
          <span class="block text-luxury-secondary">d'Inspiration</span>
        </h1>
        
        <p class="text-subtitle mb-8 max-w-2xl mx-auto">
          Parcourez nos r√©alisations d'exception et laissez-vous inspirer par l'art du maquillage professionnel.
        </p>
      </div>
    </div>
  </section>

  <!-- Luxury Gallery Section -->
  <section class="section-luxury py-16">
    <div class="container mx-auto px-6 lg:px-8">
      <!-- Filter Section -->
      <div class="max-w-md mx-auto mb-12 animate-luxury-slide-in">
        <label for="service-select" class="block font-accent text-luxury-charcoal uppercase tracking-wider text-sm mb-3">
          Filtrer par service :
        </label>
        <select 
          id="service-select" 
          name="service" 
          class="w-full px-4 py-3 border border-luxury-champagne rounded-lg focus:ring-2 focus:ring-luxury-primary focus:border-transparent transition-all duration-300 bg-luxury-ivory"
        >
          <option value="">Tous les services</option>
          {services.map((s) => <option value={s.id}>{s.nom}</option>)}
        </select>
      </div>

      <!-- Gallery Grid -->
      <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 animate-luxury-scale-in" style="animation-delay: 0.2s;">
      {galerie.length === 0 ? (
        <div class="card-luxury p-8 text-center col-span-full">
          <div class="text-luxury-primary text-4xl mb-4">üñºÔ∏è</div>
          <h3 class="text-title font-heading text-luxury-primary mb-2">Galerie en Construction</h3>
          <p class="text-luxury-taupe">Nos plus belles r√©alisations seront bient√¥t disponibles ici.</p>
        </div>
      ) : (
        galerie.map((img, idx) => (
          <button 
            type="button" 
            class="group relative focus:outline-none card-luxury overflow-hidden hover:scale-105 transition-all duration-300 focus:ring-2 focus:ring-luxury-primary" 
            data-idx={idx} 
            tabindex="0"
          >
            <img 
              src={img.imageUrl} 
              alt={img.title} 
              class="w-full h-48 object-cover group-hover:scale-110 transition-transform duration-500" 
              loading="lazy" 
            />
            <div class="absolute inset-0 bg-gradient-to-t from-luxury-charcoal/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <span class="absolute bottom-3 left-3 text-white text-sm font-medium bg-luxury-primary/90 px-3 py-1 rounded-full backdrop-blur-sm">
              {img.title}
            </span>
          </button>
        ))
      )}
    </div>

    <!-- Luxury Lightbox Dialog -->
    <dialog id="lightbox-dialog" class="card-luxury-featured max-w-4xl w-full mx-auto backdrop:bg-luxury-charcoal/80 backdrop:backdrop-blur-sm">
      <form method="dialog" class="relative">
        <button 
          id="close-lightbox" 
          class="absolute top-4 right-4 z-10 bg-luxury-primary text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-luxury-secondary transition-colors duration-300 shadow-luxury-soft" 
          aria-label="Fermer"
        >
          &times;
        </button>
      </form>
      <div class="flex flex-col items-center relative">
        <button id="prev-img" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 text-pink-700 rounded-full w-10 h-10 flex items-center justify-center shadow hover:bg-pink-100" aria-label="Image pr√©c√©dente">&#8592;</button>
        <img id="lightbox-img" src="" alt="" class="max-h-80 max-w-full rounded shadow-lg mx-8" />
        <button id="next-img" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 text-pink-700 rounded-full w-10 h-10 flex items-center justify-center shadow hover:bg-pink-100" aria-label="Image suivante">&#8594;</button>
        <div id="lightbox-title" class="mt-4 text-center text-pink-800 font-semibold"></div>
        <div id="lightbox-desc" class="text-gray-600 text-sm mt-1"></div>
      </div>
    </dialog>

    <script type="module" define:vars={{ galerie }}>
      const galerieData = galerie;
      let filtered = galerieData;
      let currentIdx = 0;
      const select = document.getElementById('service-select');
      const grid = document.getElementById('gallery-grid');
      const dialog = document.getElementById('lightbox-dialog');
      const imgEl = document.getElementById('lightbox-img');
      const titleEl = document.getElementById('lightbox-title');
      const descEl = document.getElementById('lightbox-desc');
      const prevBtn = document.getElementById('prev-img');
      const nextBtn = document.getElementById('next-img');

      function renderGrid() {
        grid.innerHTML = '';
        if (filtered.length === 0) {
          grid.innerHTML = '<div class="bg-yellow-100 text-yellow-800 p-4 rounded col-span-full">Aucune image √† afficher pour ce filtre.</div>';
          return;
        }
        filtered.forEach((img, idx) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'group relative focus:outline-none';
          btn.setAttribute('data-idx', idx);
          btn.tabIndex = 0;
          btn.innerHTML = `<img src="${img.imageUrl}" alt="${img.title}" class="w-full h-48 object-cover rounded shadow group-hover:scale-105 transition-transform" loading="lazy" /><span class="absolute bottom-2 left-2 bg-white/80 text-pink-800 text-xs px-2 py-1 rounded shadow">${img.title}</span>`;
          btn.addEventListener('click', () => openLightbox(idx));
          grid.appendChild(btn);
        });
      }

      function openLightbox(idx) {
        currentIdx = idx;
        updateLightbox();
        dialog.showModal();
      }
      function updateLightbox() {
        const img = filtered[currentIdx];
        imgEl.src = img.imageUrl;
        imgEl.alt = img.title;
        titleEl.textContent = img.title;
        descEl.textContent = img.description || '';
      }
      prevBtn.addEventListener('click', (e) => {
        e.preventDefault();
        currentIdx = (currentIdx - 1 + filtered.length) % filtered.length;
        updateLightbox();
      });
      nextBtn.addEventListener('click', (e) => {
        e.preventDefault();
        currentIdx = (currentIdx + 1) % filtered.length;
        updateLightbox();
      });
      select.addEventListener('change', (e) => {
        const val = select.value;
        filtered = val ? galerieData.filter(img => String(img.serviceId) === val || img.servicesGlobal == 1) : galerieData;
        renderGrid();
      });
      // Initial render
      renderGrid();
    </script>
  </section>
</Layout>
